name: Invoice Validation System

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate-invoices:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Enhanced RMS Debug
      env:
        RMS_URL: ${{ secrets.RMS_URL }}
      run: |
        echo "=== Enhanced RMS Connectivity Test ==="
        echo "Testing with curl..."
        curl -v -L --max-time 30 https://rms.koenig-solutions.com/Login.aspx 2>&1 | head -20
        echo ""
        echo "Testing Chrome headless access..."
        google-chrome --version
        echo "Testing basic page load..."
        timeout 30 google-chrome --headless --disable-gpu --no-sandbox --virtual-time-budget=5000 --dump-dom https://rms.koenig-solutions.com/Login.aspx > /tmp/rms_page.html 2>&1 || echo "Chrome failed"
        echo "Page size: $(wc -c < /tmp/rms_page.html 2>/dev/null || echo '0') bytes"
        echo "Contains login form: $(grep -c 'txtUser\|txtPwd' /tmp/rms_page.html 2>/dev/null || echo '0')"
        echo "================================"
    
    - name: Run invoice validation with enhanced RMS
      env:
        # RMS Configuration
        RMS_USERNAME: ${{ secrets.RMS_USER }}
        RMS_PASSWORD: ${{ secrets.RMS_PASS }}
        RMS_URL: ${{ secrets.RMS_URL }}
        
        # RMS Element Configuration (New)
        RMS_USERNAME_FIELD: "txtUser"
        RMS_PASSWORD_FIELD: "txtPwd"  
        RMS_LOGIN_BUTTON: "btnSubmit"
        RMS_DATE_FROM_FIELD: "cphMainContent_mainContent_txtDateFrom"
        RMS_DATE_TO_FIELD: "cphMainContent_mainContent_txtDateTo"
        RMS_SEARCH_BUTTON: "cphMainContent_mainContent_btnSearch"
        RMS_EXPORT_LINK: "cphMainContent_mainContent_ExportToExcel"
        RMS_INVOICE_LIST_URL: "https://rms.koenig-solutions.com/Accounts/InvoiceList.aspx"
        
        # Chrome Options for RMS
        RMS_CHROME_OPTIONS: "--no-sandbox --disable-dev-shm-usage --disable-gpu --window-size=1920,1080 --user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
        
        # Email Configuration  
        EMAIL_USERNAME: ${{ secrets.SMTP_USER }}
        EMAIL_PASSWORD: ${{ secrets.SMTP_PASS }}
        EMAIL_FROM_NAME: ${{ secrets.SMTP_FROM_NAME }}
        EMAIL_TO: ${{ secrets.AP_TEAM_EMAIL_LIST }}
        SMTP_SERVER: ${{ secrets.SMTP_HOST }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        SMTP_USE_TLS: ${{ secrets.SMTP_USE_TLS }}
        
        # Processing Configuration
        FORCE_RMS: "true"
        FORCE_EMAIL: "true"
        DISABLE_DEMO: "true"
        DEBUG_RMS: "true"
        RMS_WAIT_TIMEOUT: "30"
        
        # GitHub Token
        GITHUB_TOKEN: ${{ secrets.INVOICE_VALIDATOR_TOKEN }}
      run: |
        python main.py
        echo "Invoice validation completed!"
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: validation-results
        path: |
          *.csv
          *.xlsx
          *.db
          downloads/*.pdf
          downloads/*.zip
          downloads/*.xlsx
          downloads/*.csv
        retention-days: 30
