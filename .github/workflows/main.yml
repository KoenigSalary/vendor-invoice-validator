name: Invoice Validation System

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate-invoices:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run invoice validation
      env:
        # RMS Configuration
        RMS_USERNAME: ${{ secrets.RMS_USER }}
        RMS_PASSWORD: ${{ secrets.RMS_PASS }}
        RMS_URL: ${{ secrets.RMS_URL }}
        
        # Email Configuration  
        EMAIL_USERNAME: ${{ secrets.SMTP_USER }}
        EMAIL_PASSWORD: ${{ secrets.SMTP_PASS }}
        EMAIL_FROM_NAME: ${{ secrets.SMTP_FROM_NAME }}
        EMAIL_TO: ${{ secrets.AP_TEAM_EMAIL_LIST }}
        SMTP_SERVER: ${{ secrets.SMTP_HOST }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        SMTP_USE_TLS: ${{ secrets.SMTP_USE_TLS }}
        
        # Processing Configuration
        FORCE_RMS: "true"
        FORCE_EMAIL: "true"
        DISABLE_DEMO: "true"
        DEBUG_RMS: "true"
        
        # GitHub Token
        GITHUB_TOKEN: ${{ secrets.INVOICE_VALIDATOR_TOKEN }}
      run: |
        echo "=== RMS Configuration Debug ==="
        echo "RMS_URL is set: $([ -n "$RMS_URL" ] && echo "YES" || echo "NO")"
        echo "RMS_USERNAME is set: $([ -n "$RMS_USERNAME" ] && echo "YES" || echo "NO")"
        echo "RMS_PASSWORD is set: $([ -n "$RMS_PASSWORD" ] && echo "YES" || echo "NO")"
        echo "================================"
        python main.py
        echo "Invoice validation completed!"
        
    - name: Upload results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: validation-results
        path: |
          *.csv
          *.xlsx
          *.db
          downloads/*.pdf
          downloads/*.zip
        retention-days: 30
